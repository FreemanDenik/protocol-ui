<!DOCTYPE html>
<html lang="ru">
<head>
    <title>Домини Диртх</title>
    <!--    <base href="http://somber.online"/>-->
    <base href="http://localhost:5000"/>
    <!-- Сам придумал   -->
    <server href="http://localhost:8080"></server>
    <link type="image/png" sizes="16x16" rel="icon" href="/img/favicon.png">
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
    <meta http-equiv="content-type" content="text/html; charset=utf-8"/>
    <meta name="keywords" content="игра, детектив, средние века, фэнтази"/>
    <meta name="author" content="ImDenik"/>
    <meta name="description" content=""/>
    <!--    <meta name="generator" content="Joomla! - Open Source Content Management"/>-->

    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.0.2/dist/css/bootstrap.min.css" rel="stylesheet"
          integrity="sha384-EVSTQN3/azprG1Anm3QDgpJLIm9Nao0Yz1ztcQTwFspd3yD65VohhpuuCOmLASjC" crossorigin="anonymous">
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.0.2/dist/js/bootstrap.bundle.min.js"
            integrity="sha384-MrcW6ZMFYlzcLA8Nl+NtUVF0sA7MsXsP1UyJoMp4YLEuNSfAP+JcXn/tWtIaxVXM"
            crossorigin="anonymous"></script>
    <script src="https://code.jquery.com/jquery-3.6.1.min.js"
            integrity="sha256-o88AwQnZB+VDvE9tvIXrMQaPlFFSUTR+nldQm1LuPXQ=" crossorigin="anonymous"></script>

    <link href="/css/style.css?fcas" rel="stylesheet">
    <script src="/js/java-script.js?vsssssds"></script>

</head>
<body>

<div id="container" class='container'></div>
<div class="modal fade" id="errorModal" data-bs-backdrop="static" data-bs-keyboard="false" tabindex="-1"
     aria-labelledby="errorModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="errorModalLabel">Не большая заминка</h5>
            </div>
            <div class="modal-body">
                Сервер пока не отвечает, возможно технические работы
            </div>
            <div class="modal-footer">
                <button type="button" onclick='errorRedirect("/");' class="btn btn-primary">Понял</button>
            </div>
        </div>
    </div>
</div>
</body>
</html>
<script>

    // в переменной записаны названия параметров со значением null,
    // для того что бы идея не ругалась
    let TOKEN_INFO = {
        type: null,
        accessToken: null,
        refreshToken: null
    };
    let CLIENT_SERVER;
    let GAME_SERVER;
    let CONTAINER;
    let TARGET;
    // Функция инициализации после полной загрузки страницы
    $(async function () {
        // Инициализация глобальных переменных
        TOKEN_INFO = localStorage.getItem("token") ? JSON.parse(localStorage.getItem("token")) : null;
        CLIENT_SERVER = $('base').attr('href');
        GAME_SERVER = $('server').attr('href');
        CONTAINER = $('#container');

        // Инициализация страницы
        if (TOKEN_INFO === null) {
            CONTAINER.load('/login.html');
        } else {
            CONTAINER.load('/game.html');
        }
    })

    // Инициализация игры и первый запрос
    async function initializer() {
        // Запрос на инициализацию
        let response = await sendQuery('api/game/initializer', 'access');
        let json = await response.json();
        // Отрисовка данных игры
        printGameInfo(json);

    }

    // Шаг игры, отправить сделанный выбор и получить новое событие
    async function sendAction(event, answer) {
        // Отправляем действие
        let response = await sendQuery('api/game/go', 'access', '{"event":"' + event + '","answer":"' + answer + '"}');

        let json = await response.json();
        printGameInfo(json);

    }

    // Привязка событий к форме логин
    async function bindFormLogin(event) {
        event.preventDefault();
        let form = convertFormToJSON(event.target);
        let action = $(this).attr('action');
        let response = await sendQuery(action, null, form);

        if (!response.ok) {
            let error = await response.text();
            console.log("Ошибка на сервере: " + error);
        } else {
            let json = await response.json();
            if (json.user_already_exists) {
                console.log("Такой пользователь уже есть");
                $(this).find('div[class=display-none]').removeClass("display-none");
                $(this).find('input[name=password]').attr('disabled', false);
                $(this).find('button[type=submit]').text('Расписаться и отправиться в таверну');
                $(this).attr('action', 'api/auth/login')

            } else {
                TOKEN_INFO = json;
                localStorage.setItem("token", JSON.stringify(TOKEN_INFO));
                CONTAINER.load(CLIENT_SERVER + '/game.html');
            }
        }
    }
</script>