<!DOCTYPE html>
<html lang="ru">
<head>
    <title>Домини Диртх</title>
    <base href="http://localhost:5000"/>
    <!-- Сам придумал   -->
    <server href="http://localhost:8080"></server>

    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
    <meta http-equiv="content-type" content="text/html; charset=utf-8"/>
    <meta name="keywords" content="игра, детектив, средние века, фэнтази"/>
    <meta name="author" content="ImDenik"/>
    <meta name="description" content=""/>
    <meta name="generator" content="Joomla! - Open Source Content Management"/>

    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.0.2/dist/css/bootstrap.min.css" rel="stylesheet"
          integrity="sha384-EVSTQN3/azprG1Anm3QDgpJLIm9Nao0Yz1ztcQTwFspd3yD65VohhpuuCOmLASjC" crossorigin="anonymous">

    <script src="https://code.jquery.com/jquery-3.6.1.min.js"
            integrity="sha256-o88AwQnZB+VDvE9tvIXrMQaPlFFSUTR+nldQm1LuPXQ=" crossorigin="anonymous"></script>

    <link href="/css/style.css?fcas" rel="stylesheet">
    <script src="/js/java-script.js?vsss"></script>


</head>
<body>

<div id="container" class='container'></div>
</body>
</html>
<script>
    let TOKEN_INFO = {
        type: null,
        accessToken: null,
        refreshToken: null
    };
    let CLIENT_SERVER;
    let GAME_SERVER;
    let CONTAINER;
    let TARGET;

    $(async function () {
        // Инициализация глобальных переменных
        TOKEN_INFO = localStorage.getItem("token") ? JSON.parse(localStorage.getItem("token")) : null;
        CLIENT_SERVER = $('base').attr('href');
        GAME_SERVER = $('server').attr('href');
        CONTAINER = $('#container');

        // Инициализация страницы
        if (TOKEN_INFO === null) {
            CONTAINER.load('/login.html');
        } else {
            //REFRESH_INIT = true;
            CONTAINER.load('/game.html');
        }
    })

    // Инициализация игры и первый запрос после загрузки страницы
    async function initializer() {
        console.log("-- START метод initializer -- ");
        console.log(" запрос инициализации /api/game/initializer");
        // Запрос на инициализацию
        let response = await sendQuery('api/game/initializer', 'access');

        // Если при перезагрузке страницы, ответ 403 авторизация не успешна,
        // скорее всего протух accessToken (он короткоживущий)
        if (response.status === 403/* && REFRESH_INIT === true*/) {
            console.log(" при перезагрузке странице ответ 403 токен протух");
            console.log(" запрос на переустановку токена access токена");
            // Делаем запрос установку нового accessToken
            if (await tokenReset() === true) {
                console.log(" переустановку access токена прошла успешна");
                console.log(" запрос на переустановку всех токенов /api/auth/refresh");
                // Рекурсивная инициализация
                console.log(" рекурсивный вызов initializer");
                await initializer();
            }
        } else if (!response.ok) {
            // В случаи ошибки т.е. refresh токен протух сбрасываем все и отправляем на главную страницу
            errorRedirect("/");

        } else {
            // Если запрос успешен работаем с ним
            let json = await response.json();
            // Отрисовка данных
            printGameInfo(json);

            console.log("-- END   метод initializer -- ");
        }
    }

    // Шаг игры, отправить сделанный выбор и получить новое событие с
    async function sendAction(event, answer) {
        let response = await sendQuery('api/game/go', 'access', '{"event":"' + event + '","answer":"' + answer + '"}');

        if (response.status == 403) {
            console.log("Токен протух");
            if (await tokenReset() === true) {
                console.log("Переустановка токена и рекурсия");
                await sendAction(event, answer);
            }
        } else if (!response.ok) {
            // В случаи ошибки т.е. refresh токен протух сбрасываем все и отправляем на главную страницу
            errorRedirect("/");
        } else {
            let json = await response.json();
            printGameInfo(json);
        }
    }

    // Привязка событий к форме логин
    async function bindFormLogin(event) {
        event.preventDefault();
        let form = convertFormToJSON(event.target);
        let action = $(this).attr('action');
        let response = await sendQuery('api/auth/register', null, form);

        if (!response.ok) {
            let error = await response.text();
            console.log("Ошибка на сервере: " + error);
        } else {
            let json = await response.json();
            if (json.user_already_exists) {
                console.log("Такой пользователь уже есть");
                $(this).find('div[class=display-none]').removeClass("display-none");
                $(this).find('input[name=password]').attr('disabled', false);
                $(this).find('button[type=submit]').text('Расписаться и отправиться в таверну');
                $(this).attr('action', GAME_SERVER + '/api/auth/login')

            } else {
                console.log("token был помещен в localStorage");
                TOKEN_INFO = json;
                localStorage.setItem("token", JSON.stringify(TOKEN_INFO));
                CONTAINER.load(CLIENT_SERVER + '/game.html');
            }
        }
    }
</script>