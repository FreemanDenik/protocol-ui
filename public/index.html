<!DOCTYPE html>
<html lang="ru">
<head>
    <title>Домини Диртх</title>

    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
    <base href="https://xn----7sbadhsa7cb5cl7h.xn--p1ai/index.php"/>
    <meta http-equiv="content-type" content="text/html; charset=utf-8"/>
    <meta name="keywords" content="помощь, дети, ребёнок, инвалид, аутизм, лечение"/>
    <meta name="author" content="Super User"/>
    <meta name="description" content=""/>
    <meta name="generator" content="Joomla! - Open Source Content Management"/>

    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.0.2/dist/css/bootstrap.min.css" rel="stylesheet"
          integrity="sha384-EVSTQN3/azprG1Anm3QDgpJLIm9Nao0Yz1ztcQTwFspd3yD65VohhpuuCOmLASjC" crossorigin="anonymous">

    <script src="https://code.jquery.com/jquery-3.6.1.min.js"
            integrity="sha256-o88AwQnZB+VDvE9tvIXrMQaPlFFSUTR+nldQm1LuPXQ=" crossorigin="anonymous"></script>
    <link href="http://localhost:5000/css/style.css?fcs" rel="stylesheet">

    <script src="http://localhost:5000/js/java-script.js?vs"></script>


</head>
<body>

<div class='container'>
    <div id="login">
        <br/>
        <h1>Домини Диртх</h1>
        <hr/>
        <p> Вам поручено найти пропавшую эльфийку. <br/>
            Вам удалось узнать, что последнее место где ее видели, это в городе
            Домини Диртх, в который вы и прибыли... <br/>
            И на который спустя некоторое время напали и взяли в осаду. <br/>
        </p>
        <p> Вы отправляетесь в городскую таверну, дабы там хоть что то разузнать. </p>
        <p> Теперь по улицам не пройти без королевской грамоты, иначе вас заподозрят в шпионаже. </p>
        <p> Вот и сейчас вас остановил очередной стражник и требует грамоту, подтверждающую личность. </p>
        <hr/>


        <form id="form-login" action="http://localhost:8080/api/auth/register"  class="needs-validation" novalidate>
            <h2>Стой! Предъяви грамоту!</h2>
            <div class="login-block">
                <hr/>
                <div>
                    <input name="email" type="email" class="form-control" id="validationEmail"  placeholder="Введите email" required>
                </div>

                <hr/>
                <div style="font-size: 11px; color:brown; text-align: left">
                    На почту будет отправлено одно письмо с паролем и все! <br/>
                    Не какого спама не будет, 3-м лицам почту не передаем <br/>
                    Только вы и мы и одно письмо, все по честному! :)
                </div>
                <hr/>
            </div>
            <div class="display-none">
                <h3 id="say">Сейчас посмотрю... эм-м... Да! Есть такой.<br/>Отличной, распишитесь здесь и можешь идти.
                </h3>
                <div class="login-block">
                    <input disabled name="password" required type="password" class="form-control"
                           placeholder="Введите пароль"/>
                    <hr/>
                    <div style="font-size: 11px; color:brown; text-align: left">
                        Пароль был отправлен на почту при первом входе
                    </div>
                    <hr/>
                </div>
            </div>
            <div class="login-block">
            </div>
            <button type="submit" class="btn btn-primary">
                Предъявить грамоту
            </button>
        </form>
    </div>

    <!--  GAME  -->
    <div id="game" class="display-none">
        <br/>
        <h1>город Домини Диртх</h1>
        <hr/>
        <h2>Таверна "Грива Гавриила"</h2>
        <hr/>
        <div id="target">
            <table class="table" style="text-align: center">
                <thead>
                <tr>
                    <th scope="col">Золото</th>
                    <th scope="col">Репутация</th>
                    <th scope="col">Здоровье</th>
                    <th scope="col">Бойкость</th>
                    <th scope="col">Жажда</th>
                    <th scope="col">Скрытность</th>
                </tr>
                </thead>
                <tr>

                    <td><h3 id="gold"></h3></td>


                    <td><h3 id="reputation"></h3></td>

                    <td><h3 id="health"></h3></td>

                    <td><h3 id="fight"></h3></td>

                    <td><h3 id="thirst"></h3></td>


                    <td><h3 id="shadow"></h3></td>

                </tr>
            </table>
        </div>
        <hr/>
        <h2 id="question"></h2>
        <hr/>
        <div id="answers"></div>
        <hr/>
    </div>
</div>
</body>
</html>
<style>
    * {
        padding: 0;
        margin: 0;
    }

    hr {
        background: lightgrey
    }

    .login-block {
        max-width: 300px;

    }

    .btn, .form-control {
        border-radius: 0;
    }

    .display-none {
        display: none;
    }
</style>
<script>

    (function () {
        'use strict'

        // Fetch all the forms we want to apply custom Bootstrap validation styles to
        var forms = document.querySelectorAll('.needs-validation')

        // Loop over them and prevent submission
        Array.prototype.slice.call(forms)
            .forEach(function (form) {
                form.addEventListener('submit', function (event) {
                    if (!form.checkValidity()) {
                        event.preventDefault()
                        event.stopPropagation()
                    }

                    form.classList.add('was-validated')
                }, false)
            })
    })()

    let TOKEN_INFO;

    // GAME
    async function initializer() {

        let response = await fetch('http://localhost:8080/api/game/initializer', {
            headers: {
                'Content-Type': 'application/json',
                'Authorization': 'Bearer ' + TOKEN_INFO.accessToken,
            },
            mode: 'cors',
            method: 'POST'
        });
        let json = await response.json();
        $('#gold').text(json.first.gold)
        $('#reputation').text(json.first.reputation)
        $('#health').text(json.first.health)
        $('#thirst').text(json.first.thirst)
        $('#fight').text(json.first.fight)
        $('#shadow').text(json.first.shadow)
        console.log(json);
        $('#question').text(json.second.question);
        $.each(json.second.answers, function (e, i) {
            $('#answers').append(
                $('<button/>', {
                    text: i.text,
                    'class': 'btn btn-primary',
                    click: function () {
                        send(json.second.id, i.id);
                    }
                })
            ).append("<br/><br/>");
        })
    }

    async function send(event, answer) {

        let response = await fetch('http://localhost:8080/api/game/go', {
            headers: {
                'Content-Type': 'application/json',
                'Authorization': 'Bearer ' + TOKEN_INFO.accessToken,
            },
            mode: 'cors',
            method: 'POST',
            body: '{"event":"' + event + '","answer":"' + answer + '"}'
        });
        let json = await response.json();
        $('#gold').text(json.first.gold)
        $('#reputation').text(json.first.reputation)
        $('#health').text(json.first.health)
        $('#thirst').text(json.first.thirst)
        $('#fight').text(json.first.fight)
        $('#shadow').text(json.first.shadow)
        console.log(json);
        $('#question').text(json.second.question);
        $('#answers').empty();
        $.each(json.second.answers, function (e, i) {
            $('#answers').append(
                $('<button/>', {
                    text: i.text,
                    'class': 'btn btn-primary',
                    click: function () {
                        send(json.second.id, i.id);
                    }
                })
            ).append("<br/><br/>");
        })
    }


    $(function () {

        // Регистрация и вход
        $('#login #form-login').on('submit', async function (event) {
            event.preventDefault();
            let form = convertFormToJSON(event.target);

            let action = $(this).attr('action');

            let response = await fetch(action, {
                headers: {
                    'Content-Type': 'application/json'
                },
                mode: 'cors',
                method: 'POST',
                body: form
            });

            if (!response.ok) {
                let error = await response.text();
                console.log("Ошибка на сервере: " + error);
            } else {
                let data = await response.json();
                if (data.user_already_exists) {
                    console.log("Такой пользователь уже есть");
                    $(this).find('div[class=display-none]').removeClass("display-none");
                    $(this).find('input[name=password]').attr('disabled', false);
                    $(this).find('button[type=submit]').text('Расписаться и отправиться в таверну');
                    $(this).attr('action', 'http://localhost:8080/api/auth/login')

                } else {


                    console.log("token был помещен в localStorage");
                    TOKEN_INFO = data;
                    localStorage.setItem("token", data);
                    $('#login').remove();
                    $('#game').removeClass('display-none');
                    initializer();

                }
            }
        })
    })
</script>